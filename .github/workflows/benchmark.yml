name: Benchmark

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  benchmark:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Install benchstat
        run: go install golang.org/x/perf/cmd/benchstat@latest

      - name: Run benchmarks on current branch
        run: |
          go test -bench=. -benchmem -count=5 ./benchmarks > new.txt
          cat new.txt

      - name: Download baseline benchmarks
        id: download-baseline
        continue-on-error: true
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: benchmark.yml
          branch: main
          name: benchmark-results
          path: .

      - name: Compare benchmarks
        id: compare
        if: steps.download-baseline.outcome == 'success'
        run: |
          if [ -f baseline.txt ]; then
            echo "## Benchmark Comparison" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            benchstat baseline.txt new.txt >> $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY

            # Check for significant regressions
            if benchstat -split="XYZ" baseline.txt new.txt | grep -E '\+[0-9]{2,}\.[0-9]+%' > regressions.txt 2>/dev/null; then
              echo "âš ï¸ Performance regressions detected!" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              cat regressions.txt >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "No baseline found, establishing new baseline"
          fi

      - name: Upload benchmark results
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: new.txt
          retention-days: 90

      - name: Comment PR
        if: github.event_name == 'pull_request' && steps.download-baseline.outcome == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const benchstat = fs.readFileSync('${{ github.step_summary }}', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ“Š Benchmark Results\n\n${benchstat}`
            });

  performance-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Check PR List Performance
        run: |
          echo "Checking PR list navigation performance (target: <100ms P95)..."
          result=$(go test -bench=BenchmarkPRListFiltering -benchmem -count=5 ./benchmarks | grep BenchmarkPRListFiltering | tail -1)
          echo "$result"

          # Extract ns/op (simplified check)
          time_ns=$(echo "$result" | awk '{print $3}')
          echo "Time: $time_ns"

      - name: Check Startup Performance
        run: |
          echo "Checking startup performance (target: <2s)..."
          result=$(go test -bench=BenchmarkFullStartup -benchmem -count=5 ./benchmarks | grep BenchmarkFullStartup | tail -1)
          echo "$result"

      - name: Check Memory Usage
        run: |
          echo "Checking memory allocation patterns..."
          go test -bench=BenchmarkMemory -benchmem ./benchmarks

      - name: Generate Performance Report
        run: |
          echo "## Performance Metrics" > performance-report.md
          echo "" >> performance-report.md
          echo "### PR List Operations" >> performance-report.md
          go test -bench=BenchmarkPRList -benchmem ./benchmarks >> performance-report.md
          echo "" >> performance-report.md
          echo "### Diff Rendering" >> performance-report.md
          go test -bench=BenchmarkDiff -benchmem ./benchmarks >> performance-report.md
          echo "" >> performance-report.md
          echo "### Startup" >> performance-report.md
          go test -bench=BenchmarkFullStartup -benchmem ./benchmarks >> performance-report.md
          cat performance-report.md >> $GITHUB_STEP_SUMMARY

      - name: Upload performance report
        uses: actions/upload-artifact@v4
        with:
          name: performance-report
          path: performance-report.md
          retention-days: 30
